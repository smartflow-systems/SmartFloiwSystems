set -euo pipefail

# Work within the accessible workspace
WORKSPACE="/workspace"
SFS_TEMPLATE="$WORKSPACE/sfs-genesis-template"
SFS_GENERATOR="$WORKSPACE/create-sfs-app.sh"

echo "ğŸ¯ Creating portable SFS Genesis System..."
echo ""

# Copy current workspace to template directory
if [ -d "$SFS_TEMPLATE" ]; then
    echo "âš ï¸  Template already exists, backing up..."
    mv "$SFS_TEMPLATE" "${SFS_TEMPLATE}.backup.$(date +%s)"
fi

echo "ğŸ“¦ Creating template structure..."
mkdir -p "$SFS_TEMPLATE"
cp -r "$WORKSPACE"/{src,scripts,public,*.json,*.js,*.ts,*.html,*.md,*.config.js,.github} "$SFS_TEMPLATE/" 2>/dev/null || true

# Create the portable generator script
cat > "$SFS_GENERATOR" << 'SCRIPT_EOF'
#!/bin/bash
set -euo pipefail

# ============================================================================
# SFS PORTABLE APP GENERATOR
# Works in any directory - just set TEMPLATE_DIR and OUTPUT_DIR
# ============================================================================

# Configuration - adjust these paths as needed
TEMPLATE_DIR="${SFS_TEMPLATE_DIR:-./sfs-genesis-template}"
OUTPUT_DIR="${SFS_OUTPUT_DIR:-.}"

# Colors
GOLD='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GOLD}ğŸš€ SmartFlow Systems - App Generator${NC}"
echo ""

# Check template
if [ ! -d "$TEMPLATE_DIR" ]; then
    echo -e "${RED}âŒ Template not found at: $TEMPLATE_DIR${NC}"
    echo ""
    echo "Set template location:"
    echo "  export SFS_TEMPLATE_DIR=/path/to/sfs-genesis-template"
    echo "  ./create-sfs-app.sh my-app 'Description'"
    exit 1
fi

# Get project details
if [ -z "${1:-}" ]; then
    echo "Usage: ./create-sfs-app.sh <project-name> [description]"
    echo ""
    echo "Examples:"
    echo "  ./create-sfs-app.sh sfs-analytics-pro 'AI analytics dashboard'"
    echo "  ./create-sfs-app.sh booking-v2 'Modern booking platform'"
    echo ""
    echo "Environment variables:"
    echo "  SFS_TEMPLATE_DIR   - Path to genesis template (default: ./sfs-genesis-template)"
    echo "  SFS_OUTPUT_DIR     - Output directory (default: current directory)"
    exit 1
fi

PROJECT_NAME="$1"
PROJECT_DESC="${2:-A SmartFlow Systems application}"
PROJECT_DIR="$OUTPUT_DIR/$PROJECT_NAME"

# Validation
if [[ ! "$PROJECT_NAME" =~ ^[a-z0-9-]+$ ]]; then
    echo -e "${RED}âŒ Invalid name. Use: lowercase, numbers, hyphens${NC}"
    exit 1
fi

if [ -d "$PROJECT_DIR" ]; then
    echo -e "${RED}âŒ Project exists: $PROJECT_DIR${NC}"
    exit 1
fi

echo -e "${GREEN}ğŸ“¦ Creating: ${BLUE}$PROJECT_NAME${NC}"
echo -e "${GOLD}ğŸ“ $PROJECT_DESC${NC}"
echo ""

# Clone template
echo "ğŸ“‹ Cloning template..."
cp -r "$TEMPLATE_DIR" "$PROJECT_DIR"
cd "$PROJECT_DIR"

# Clean up backup files if any
rm -rf *.backup.* 2>/dev/null || true

# Update package.json
echo "âš™ï¸  Configuring package.json..."
cat > package.json << EOF
{
  "name": "$PROJECT_NAME",
  "version": "1.0.0",
  "description": "$PROJECT_DESC",
  "type": "module",
  "scripts": {
    "dev": "vite --host 0.0.0.0 --port \${PORT:-5000}",
    "build": "tsc && vite build",
    "preview": "vite preview --host 0.0.0.0 --port \${PORT:-5000}",
    "health": "node scripts/health.js"
  },
  "dependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "express": "^4.18.2"
  },
  "devDependencies": {
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "@vitejs/plugin-react": "^4.3.4",
    "typescript": "^5.6.3",
    "vite": "^5.4.11",
    "tailwindcss": "^3.4.17",
    "postcss": "^8.4.49",
    "autoprefixer": "^10.4.20"
  },
  "keywords": ["smartflow-systems", "sfs", "react", "typescript"],
  "author": "boweazy (SmartFlow Systems)",
  "license": "PROPRIETARY"
}
EOF

# Update README
echo "ğŸ“„ Generating README..."
TITLE_CAPS=$(echo "$PROJECT_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')

cat > README.md << EOF
# ğŸš€ $TITLE_CAPS

$PROJECT_DESC

**Part of the SmartFlow Systems ecosystem**

## ğŸ¯ Overview

Built from SFS Genesis Template:
- âš¡ React 19 + TypeScript 5 + Vite 5
- ğŸ¨ SFS Brown/Black/Gold theme
- ğŸ”§ Tailwind CSS custom utilities
- âœ… Health check endpoint
- ğŸš€ Production ready

## ğŸš€ Quick Start

\`\`\`bash
npm install    # Install dependencies
npm run dev    # Start dev server
npm run build  # Build for production
\`\`\`

## ğŸ¨ SFS Theme

\`\`\`css
Black:  #0D0D0D  bg-sfs-black
Brown:  #3B2F2F  bg-sfs-brown
Gold:   #FFD700  bg-sfs-gold
Beige:  #F5F5DC  bg-sfs-beige
\`\`\`

**Custom Classes:**
- \`.sfs-gradient\` - Brown to black gradient
- \`.sfs-button\` - Gold button with hover
- \`.sfs-card\` - Brown card with backdrop blur

## ğŸ“ Structure

\`\`\`
$PROJECT_NAME/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/  # React components
â”‚   â”œâ”€â”€ styles/      # CSS & Tailwind
â”‚   â”œâ”€â”€ App.tsx      # Main app
â”‚   â””â”€â”€ main.tsx     # Entry point
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ health.js    # Health check
â”œâ”€â”€ server.js        # Express server
â””â”€â”€ vite.config.ts   # Vite config
\`\`\`

## âœ… Health Check

\`GET /api/health\` â†’ \`{"ok":true,"timestamp":"..."}\`

## ğŸŒ Deployment

### GitHub
\`\`\`bash
git remote add origin https://github.com/smartflow-systems/$PROJECT_NAME.git
git push -u origin main
\`\`\`

### Replit
1. Import repository
2. Run automatically starts
3. Optional: Set PORT env var

## ğŸ¤ SFS Ecosystem

- **Organization**: [SmartFlow Systems](https://github.com/smartflow-systems)
- **Developer**: boweazy
- **Created**: $(date +%Y-%m-%d)

---

**Built with ğŸ’› by SmartFlow Systems**
EOF

# Update HTML title
echo "ğŸ·ï¸  Updating HTML..."
sed -i "s/<title>.*<\/title>/<title>$TITLE_CAPS | SmartFlow Systems<\/title>/" index.html 2>/dev/null || true

# Update App.tsx
echo "ğŸ¨ Customizing app..."
if [ -f "src/App.tsx" ]; then
    sed -i "s/SFS Genesis Template/$TITLE_CAPS/g" src/App.tsx
    sed -i "s/The Perfect Starting Point for SmartFlow Systems Apps/$PROJECT_DESC/g" src/App.tsx
fi

# Clean git history
echo "ğŸ—‘ï¸  Cleaning template git..."
rm -rf .git .gitignore

# Create fresh git repo
echo "ğŸ“¦ Initializing git..."
cat > .gitignore << 'GITEOF'
node_modules/
dist/
build/
.env
.env.local
.DS_Store
*.log
GITEOF

git init
git add .
git commit -m "ğŸ‰ Initial commit: $TITLE_CAPS

$PROJECT_DESC

Generated from SFS Genesis Template
$(date +%Y-%m-%d)

Stack:
- React 19 + TypeScript 5
- Vite 5 + Tailwind CSS
- SFS Brown/Black/Gold theme
- Express health checks"

echo ""
echo -e "${GREEN}âœ… SUCCESS! Project created${NC}"
echo ""
echo -e "${GOLD}ğŸ“ Location:${NC} $PROJECT_DIR"
echo ""
echo -e "${BLUE}ğŸ“‹ Next Steps:${NC}"
echo "   cd $PROJECT_NAME"
echo "   npm install"
echo "   npm run dev"
echo ""
echo -e "${BLUE}ğŸŒ GitHub:${NC}"
echo "   git remote add origin https://github.com/smartflow-systems/$PROJECT_NAME.git"
echo "   git push -u origin main"
echo ""
echo -e "${GREEN}Happy coding! ğŸš€${NC}"
SCRIPT_EOF

chmod +x "$SFS_GENERATOR"

# Create quick setup guide
cat > "$WORKSPACE/SETUP_GUIDE.md" << 'EOF'
# ğŸš€ SFS Genesis - Setup Guide

## Quick Start (Any Machine)

### 1. Download the System
```bash
# Clone or download this repository
git clone <your-repo-url> sfs-system
cd sfs-system
```

### 2. Generate Your First App
```bash
# Make generator executable
chmod +x create-sfs-app.sh

# Create a new app
./create-sfs-app.sh my-awesome-app "My first SFS application"

# Navigate and run
cd my-awesome-app
npm install
npm run dev
```

## ğŸ¯ Environment Variables
```bash
# Optional: Set custom paths
export SFS_TEMPLATE_DIR=/path/to/sfs-genesis-template
export SFS_OUTPUT_DIR=/path/to/projects

./create-sfs-app.sh new-app "Description"
```

## ğŸ“¦ What Gets Generated

Each new project includes:
- âœ… React 19 + TypeScript 5 + Vite 5
- âœ… SFS Brown/Black/Gold theme
- âœ… Tailwind CSS with custom utilities
- âœ… Health check endpoint
- âœ… GitHub Actions CI/CD ready
- âœ… Custom README with project details
- âœ… Fresh git repository

## ğŸ¨ Projects You Can Build
```bash
# Analytics Platform
./create-sfs-app.sh sfs-analytics-pro "AI-powered data analytics"

# Booking System
./create-sfs-app.sh booking-platform-v2 "Modern service booking"

# Marketing Tool
./create-sfs-app.sh content-scheduler "AI content automation"

# Social Media Manager
./create-sfs-app.sh social-manager "Multi-platform social automation"

# CRM System
./create-sfs-app.sh client-crm "Customer relationship management"
```

## ğŸ”§ Customizing the Template

Edit `sfs-genesis-template/` to change defaults:
- `src/styles/index.css` - Theme colors
- `tailwind.config.js` - Tailwind config
- `src/App.tsx` - Default layout
- `src/components/` - Reusable components

All new projects will inherit your changes!

## ğŸŒ Deploying to GitHub
```bash
cd your-new-project

# Create repo on GitHub first, then:
git remote add origin https://github.com/smartflow-systems/your-project.git
git push -u origin main
```

## ğŸ“‹ Common Commands

| Command | Description |
|---------|-------------|
| `npm run dev` | Start development server |
| `npm run build` | Build for production |
| `npm run preview` | Preview production build |
| `npm run health` | Check app health |

## ğŸ¯ SFS Theme Reference
```css
/* Colors */
bg-sfs-black      /* #0D0D0D */
bg-sfs-brown      /* #3B2F2F */
bg-sfs-gold       /* #FFD700 */
bg-sfs-beige      /* #F5F5DC */

/* Utilities */
.sfs-gradient     /* Brown â†’ Black gradient */
.sfs-button       /* Gold button style */
.sfs-card         /* Brown card with blur */
```

## ğŸ†˜ Troubleshooting

**Template not found?**
```bash
export SFS_TEMPLATE_DIR=/full/path/to/sfs-genesis-template
```

**Permission denied?**
```bash
chmod +x create-sfs-app.sh
```

**Port already in use?**
```bash
PORT=3000 npm run dev
```

---

**Built with ğŸ’› by SmartFlow Systems**
EOF

echo ""
echo -e "${GREEN}âœ… SFS Genesis System Ready!${NC}"
echo ""
echo -e "${GOLD}ğŸ“¦ Files Created:${NC}"
echo "   $SFS_TEMPLATE (template)"
echo "   $SFS_GENERATOR (generator script)"
echo "   $WORKSPACE/SETUP_GUIDE.md (documentation)"
echo ""
echo -e "${BLUE}ğŸ¯ Test It Now:${NC}"
echo "   ./create-sfs-app.sh test-app 'My test application'"
echo ""
echo -e "${BLUE}ğŸ“– Read Setup Guide:${NC}"
echo "   cat SETUP_GUIDE.md"